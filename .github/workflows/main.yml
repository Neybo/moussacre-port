name: Android CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > myTemporaryFile.keystore

      - name: Create local settings override file
        run: |
          echo '{
            "machine.Platform Settings.Android.Keystore.filename": "./myTemporaryFile.keystore",
            "machine.Platform Settings.Android.Keystore.keystore_password": "${{ WSpDRkRYVUBT }}",
            "machine.Platform Settings.Android.Keystore.keystore_alias_password": "${{ WSpDRkRYVUBT }}",
            "machine.Platform Settings.Android.Keystore.alias": "${{ moussacre }}"
          }' > local_settings.json

      - name: Set up ffmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '7.0.1'

      - name: Set up Android SDK platform-tools
        run: |
          ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"

      - name: Use Igor Setup
        uses: bscotch/igor-setup@v1
        with:
          local-settings-override-file: ${{ github.workspace }}/local_settings.json
          target-yyp: ${{ github.workspace }}/**/*.yyp
          access-key: "${{ a41c34c321bfd93a09756c428fc0a09c }}"

      - name: Build with Igor
        uses: bscotch/igor-build@v1
        with:
          yyp-path: ${{ github.workspace }}/**/*.yyp
          user-dir: ${{ steps.igor.outputs.user-dir }}

      - name: Upload build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: ${{ steps.build.outputs.out-dir }}
          retention-days: 10
